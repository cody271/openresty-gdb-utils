
* `$ /opt/circonus/bin/luajit backtrace/segfault.lua`
```
reading bad memory..
Segmentation fault (core dumped)
```

* `$ PYTHONPATH=. gdb --batch --command=backtrace/lbt_full.gdb /opt/circonus/bin/luajit backtrace/segfault.core`
```
[New LWP 20389]
Core was generated by `/opt/circonus/bin/luajit backtrace/segfault.lua'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007f907621ebd7 in lj_cconv_ct_ct (cts=<optimized out>, d=<optimized out>, s=0x406f7978, dp=0x406f08f8 "", sp=0xdeadbeef <error: Cannot access memory at address 0xdeadbeef>, flags=0) at lj_cconv.c:234

builtin#163 [ffi.meta.__index]
@backtrace/segfault.lua:5
	local "p":
		type cdata
			cdata object: (GCcdata*)0x406f9fe0
			cdata value pointer: (void*)0x406f9fe8
			ctype object: (CType*)0x406f7ee8
			ctype size: 8 byte(s)
			ctype type: ptr
@backtrace/segfault.lua:10
@backtrace/segfault.lua:11
	local "A":
		function segfault.lua:10: (GCfunc*)0x406f9fc0
@backtrace/segfault.lua:14
	local "ffi":
		table: (TValue*)0x406f0898
	local "B":
		function segfault.lua:3: (GCfunc*)0x406f9f40
C:pmain
```

* `$ /opt/circonus/bin/luamtev backtrace/mtev_segfault.lua`
```
reading bad memory..
STACKTRACE(20614):
t@20614> /opt/circonus/lib/libmtev.so.1'mtev_stacktrace+0x50
t@20614> /opt/circonus/lib/libmtev.so.1'mtev_self_diagnose+0x12
t@20614> /lib/x86_64-linux-gnu/libpthread.so.0'+0x13150
t@20614> /opt/circonus/lib/libluajit-5.1.so.2'+0x4abd7
t@20614> /opt/circonus/lib/libluajit-5.1.so.2'+0x4ad25
t@20614> /opt/circonus/lib/libluajit-5.1.so.2'+0x5fc12
t@20614> /opt/circonus/lib/libluajit-5.1.so.2'+0x9c97
t@20614> /opt/circonus/libexec/mtev/lua_mtev.so'+0xada2
t@20614> /opt/circonus/libexec/mtev/lua_mtev.so'dispatch_general+0x2f4
t@20614> /opt/circonus/lib/libmtev.so.1'eventer_dispatch_timed+0x15b
t@20614> /opt/circonus/lib/libmtev.so.1'+0x7dfcb
t@20614> /opt/circonus/lib/libmtev.so.1'+0x78f6c
t@20614> /opt/circonus/bin/luamtev'+0x2474
t@20614> /opt/circonus/lib/libmtev.so.1'mtev_main+0x77b
t@20614> /opt/circonus/bin/luamtev'main+0x2a4
t@20614> /lib/x86_64-linux-gnu/libc.so.6'__libc_start_main+0xf1
t@20614> /opt/circonus/bin/luamtev'_start+0x2a
t@20614> 
Segmentation fault (core dumped)
```

* `$ PYTHONPATH=. gdb --batch --command=backtrace/lbt_full.gdb /opt/circonus/bin/luamtev backtrace/mtev_segfault.core`
```
[New LWP 20614]
[New LWP 20621]
[New LWP 20615]
[New LWP 20618]
[New LWP 20616]
[New LWP 20620]
[New LWP 20623]
[New LWP 20619]
[New LWP 20624]
[New LWP 20622]
[New LWP 20617]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `/opt/circonus/bin/luamtev backtrace/mtev_segfault.lua'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007f2a4cc6ebd7 in lj_cconv_ct_ct (cts=<optimized out>, d=<optimized out>, s=0x418ab1e8, dp=0x418a4aa0 "", sp=0xdeadbeef <error: Cannot access memory at address 0xdeadbeef>, flags=0) at lj_cconv.c:234
[Current thread is 1 (Thread 0x7f2a4d606800 (LWP 20614))]

backtrace/lbt_full.gdb:2: Error in sourced command file:
No global L located (tried globalL and ngx_cycle)
```

* **Rebuild `luamtev` with global_state.patch applied**
```
diff --git a/src/modules/lua_general.c b/src/modules/lua_general.c
index 51ca6d50..072ae7ef 100644
--- a/src/modules/lua_general.c
+++ b/src/modules/lua_general.c
@@ -638,6 +638,8 @@ lua_general_hook(lua_State *L) {
   return 1;
 }
 
+static lua_State *globalL = NULL;
+
 static const luaL_Reg general_lua_funcs[] =
 {
   {"coroutine_spawn", lua_general_coroutine_spawn },
@@ -683,6 +685,7 @@ mtev_lua_general_init(mtev_dso_generic_t *self) {
   luaL_openlib(lmc->lua_state, "mtev", general_lua_funcs, 0);
   /* Load some preloads */
 
+  globalL = lmc->lua_state;
   for(module = conf->Cpreloads; module && *module; module++) {
     int len;
     char *symbol = NULL;
```

* `$ PYTHONPATH=. gdb --batch --command=backtrace/lbt_full.gdb /opt/circonus/bin/luamtev backtrace/mtev_segfault.core`
```
[New LWP 20614]
[New LWP 20621]
[New LWP 20615]
[New LWP 20618]
[New LWP 20616]
[New LWP 20620]
[New LWP 20623]
[New LWP 20619]
[New LWP 20624]
[New LWP 20622]
[New LWP 20617]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `/opt/circonus/bin/luamtev backtrace/mtev_segfault.lua'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00007f2a4cc6ebd7 in lj_cconv_ct_ct (cts=<optimized out>, d=<optimized out>, s=0x418ab1e8, dp=0x418a4aa0 "", sp=0xdeadbeef <error: Cannot access memory at address 0xdeadbeef>, flags=0) at lj_cconv.c:234
[Current thread is 1 (Thread 0x7f2a4d606800 (LWP 20614))]

builtin#163 [ffi.meta.__index]
@backtrace/mtev_segfault.lua:9
	local "p":
		type cdata
			cdata object: (GCcdata*)0x40002c78
			cdata value pointer: (void*)0x40002c80
			ctype object: (CType*)0x400087a8
			ctype size: 8 byte(s)
			ctype type: ptr
@backtrace/mtev_segfault.lua:14
@backtrace/mtev_segfault.lua:15
	local "A":
		function mtev_segfault.lua:14: (GCfunc*)0x40002c58
```

* `$ /opt/circonus/bin/luajit backtrace/segfault_sigsegv.lua`
```
reading bad memory..
stack traceback:
	backtrace/segfault_sigsegv.lua:7: in function <backtrace/segfault_sigsegv.lua:6>
	[C]: in function '__index'
	backtrace/segfault_sigsegv.lua:13: in function 'B'
	backtrace/segfault_sigsegv.lua:18: in function 'A'
	backtrace/segfault_sigsegv.lua:19: in function 'main'
	backtrace/segfault_sigsegv.lua:22: in main chunk
	[C]: at 0x557a9177c200
```
